<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="estilo.css">
<link rel="stylesheet" href="normalize.css">
<link rel="stylesheet" href="css/bootstrap.min.css">
<title>Pizza Tower - Web Edition</title>
<style>
:root {
    --game-base-width: 900px;
    --game-base-height: 500px;}
body {
    font-family: PzzTwr;
    background-color: #54260d;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 20px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;}
.icon-mode-noise { background-image: url(imagens_jogo/Stuff/Noise_Mode.gif) !important; }
.icon-mode-doise { background-image: url(imagens_jogo/Stuff/Doise_Mode.gif) !important; }
.icon-unmute { background-image: url(imagens_jogo/Stuff/unmute_button.png) !important; }
.icon-mute { background-image: url(imagens_jogo/Stuff/mute_button.png) !important; }
.icon-fullscreen-enter { background-image: url(imagens_jogo/Stuff/fullscreen_on.png) !important; }
.icon-fullscreen-exit { background-image: url(imagens_jogo/Stuff/fullscreen_off.png) !important; }
#main-container {
    position: relative;
    width: 100%;
    max-width: var(--game-base-width);
    aspect-ratio: 9 / 5;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    border: 5px solid black;
    overflow: hidden;
    margin: auto;
    height: auto;
    min-height: 200px;}
:fullscreen #main-container {
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    max-width: none;
    max-height: none;
    margin: 0;
    border: none;}
#start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url(imagens_jogo/Stuff/Title_screen.png);
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    z-index: 20;
    color: white;}
#mute-button, #desktop-fullscreen-button, #mode-switch-button {
    position: fixed; 
    top: 20px; 
    background: none; 
    border: none; 
    cursor: pointer; 
    z-index: 1000; 
    width: 40px; 
    height: 40px; 
    background-size: contain; 
    background-repeat: no-repeat;
    background-color: rgba(0,0,0,0.2);
    border-radius: 5px;}
#mute-button { right: 20px; }
#desktop-fullscreen-button { right: 70px; }
#mode-switch-button { right: 120px; }
#game-area {
    width: 100%;
    height: 100%;
    background-color: black;
    background-image: url(imagens_jogo/Stuff/backwoag.png);
    background-size: cover;
    background-repeat: no-repeat;
    position: relative;
    display: none;}
#player, #the-noise, .platform, .topping, .power-up {
    position: absolute;
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 10;}
.facing-left { transform: scaleX(-1); }

/* SPRITES */
.moving-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_walk.gif); }
.running-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_run.gif); }
.jumping-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_jump.gif); }
.wall-slide-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_wall.gif); }
.peppino-hurt-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_hurt.gif); }
.peppino-stun-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_fireass.gif); }
.stomp-mode { background-image: url(imagens_jogo/P_sprites/Peppino_stomp.gif); }
.peppino-win-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_win.gif); }
.peppino-lose-sprite { background-image: url(imagens_jogo/P_sprites/Peppino_lose.gif); }
.invincible { opacity: 0.7; animation: flicker 0.1s infinite alternate; }
.is-stunned { pointer-events: none; }
.peppino-tired-sprite { background-image: url(imagens_jogo/Peppino_milk.gif); }
#the-noise {
    width: 75px;
    height: 100px;
    position: absolute;
    bottom: 0;
    left: 700px;
    background-image: url(imagens_jogo/Noise_walk.gif);
    background-size: contain;
    background-repeat: no-repeat;
    text-indent: -9999px;
    border-radius: 5px;
    z-index: 9;
    transition: opacity 0.1s;}
.noise-jumping { background-image: url(imagens_jogo/N_sprites/Noise_jump.png); }
.noise-double-jump { background-image: url(imagens_jogo/N_sprites/Noise_doublejump.gif); }
.noise-win-sprite { background-image: url(imagens_jogo/N_sprites/Noise_win.gif); }
.noise-disabled { opacity: 0.7; transform: translateY(10px); background-image: url(imagens_jogo/Noise_hurt.gif); }
.noise-joke-mode { opacity: 1; pointer-events: none; }
.noise-happy { background-image: url(imagens_jogo/N_sprites/Noise_happy.gif); }
.noise-scared { background-image: url(imagens_jogo/N_sprites/Noise_scaried.gif); }
.noise-powered-up { background-image: url(imagens_jogo/N_sprites/Pepper_Pizza_Noise.gif); }
.noise-tired-sprite { background-image: url(imagens_jogo/N_sprites/Noise_milk.gif); }

#gustavo {
    position: absolute;
    width: 60px;
    height: 80px;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 5;}
.gustavo-idle-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_idle.gif); }
.gustavo-noise-hit-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_N_hit.gif); }
.gustavo-drop-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_drop.gif); }
.gustavo-peppino-hit-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_P_hit.gif); }
.gustavo-pepper-peppino-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_PP.gif); }
.gustavo-pepper-noise-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_PN.gif); }
.gustavo-win-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_P_win.gif); }
.gustavo-lose-sprite { background-image: url(imagens_jogo/G_sprites/Gustavo_N_win.gif); }
.power-up {
    width: 35px;
    height: 35px;
    position: absolute;
    background-size: contain;
    background-repeat: no-repeat;
    animation: glow 1s infinite alternate;
    z-index: 12;}
.invincibility-powerup { background-image: url(imagens_jogo/Toppings/Pepper_Pizza.gif); }
@keyframes flicker { from { opacity: 1; } to { opacity: 0.7; } }
@keyframes glow { from { box-shadow: 0 0 5px orange, 0 0 10px yellow; } to { box-shadow: 0 0 10px orange, 0 0 20px yellow; } }

/* PLATAFORMA E ITENS */
.platform {
    position: absolute;
    background-color: #d98918;
    border: 3px solid black;
    border-radius: 5px;}
.topping {
    width: 25px;
    height: 25px;
    position: absolute;
    background-size: contain;
    background-repeat: no-repeat;
    text-indent: -9999px;
    border-radius: 50%;
    animation: bounce 0.5s infinite alternate;
    z-index: 8;}
.topping-1 { background-image: url(imagens_jogo/Toppings/Mushroom.gif); }
.topping-2 { background-image: url(imagens_jogo/Toppings/Cheese.gif); }
.topping-3 { background-image: url(imagens_jogo/Toppings/Tomato.gif); }
.topping-4 { background-image: url(imagens_jogo/Toppings/Weiner.gif); }
.topping-5 { background-image: url(imagens_jogo/Toppings/Pineapple.gif); }
.topping-gerome { background-image: url(imagens_jogo/Toppings/Gerome.gif); }
.topping-life { background-image: url(imagens_jogo/Toppings/Life_hat.png); border-radius: 5px; }
@keyframes bounce { from { transform: translateY(0px); } to { transform: translateY(-5px); } }
#ui-bar {
    width: 100%;
    max-width: 900px;
    margin-bottom: 15px;
    display: none;
    justify-content: space-between;
    font-size: 1.5em;
    font-weight: bold;
    color: yellow;}
#score, #timer, #health {
    background-color: #54260d;
    padding: 5px 15px;
    border: 2px solid black;
    color: white;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 150px;
    text-align: center;}
#health { min-width: 250px; justify-content: space-around; flex-direction: row; }
#heart-icon { width: 25px; height: 25px; background-size: contain; background-repeat: no-repeat; margin-right: 5px; display: inline-block; background-image: url(imagens_jogo/Stuff/Peppino_hat.png); }
#empty-heart-icon { width: 25px; height: 25px; background-size: contain; background-repeat: no-repeat; margin-right: 5px; display: inline-block; background-image: url(imagens_jogo/Stuff/Peppino_hat_damaged.png); }
.final-rank-image {
    width: 350px;
    height: 200px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin: 20px auto 0;
    background-color: transparent;}
.rank-P-image { background-image: url(imagens_jogo/Ranks/P-Rank.png); border: 3px solid black; }
.rank-S-image { background-image: url(imagens_jogo/Ranks/S-Rank.png); border: 3px solid black; }
.rank-A-image { background-image: url(imagens_jogo/Ranks/A-Rank.png); border: 3px solid black; }
.rank-B-image { background-image: url(imagens_jogo/Ranks/B-Rank.jpg); border: 3px solid black; }
.rank-C-image { background-image: url(imagens_jogo/Ranks/C-Rank.png); border: 33px solid black; }
.rank-D-image { background-image: url(imagens_jogo/Ranks/D-Rank.png); border: 3px solid black; }
.rank-F-image { background-image: url(imagens_jogo/Ranks/F-Rank.png); border: 3px solid black; }
.rank-IDK-image { background-image: url(imagens_jogo/Ranks/IDK-Rank.png); border: 3px solid #d0b8b8; }
.rank-DEAD-image { background-image: url(imagens_jogo/Ranks/DEAD_Rank.png); border: 5px solid black; filter: drop-shadow(0 0 10px #d0b8b8); }
.message { margin-top: 20px; font-size: 2em; font-weight: bold; min-height: 50px; }
.message2 { margin-top: 20px; font-size: 2em; font-weight: bold; color: black; min-height: 50px; }
.depression {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 30px;
    font-size: 2em;
    font-weight: bold;
    cursor: pointer;
    background-color: #f1c40f;
    color: #54260d;
    border: 5px solid black;
    border-radius: 10px;
    box-shadow: 0 8px #d35400;
    transition: transform 0.1s, box-shadow 0.1s;
    z-index: 30;}
.depression:hover { background-color: #f39c12; }
.doise-btn {
    background-color: #48a0f9 !important;
    color: white !important;
    left: auto !important;
    transform: none !important;
    margin-top: 0;
    position: absolute;
    right: 20px;
    bottom: 20px;
    border: 4px solid #2c6ebf !important;
    border-bottom-color: #d868a0 !important;
    font-size: 1.1em;
    padding: 8px 15px;
    z-index: 100;}
.doise-btn:hover { background-color: #3b8cd6 !important; transform: scale(1.05) !important; }
.doise-btn:active { transform: translateY(4px) !important; }
</style>
</head>
<body>
<div class="line"><a class="Bordalink branco Pizza_Game_Link" href="index.html"> Site Principal </a></div>
<button id="mode-switch-button" onclick="toggleGameMode()" title="Mudar Modo" class="icon-mode-doise"></button>
<button id="desktop-fullscreen-button" onclick="toggleDesktopFullscreen()" title="Modo Tela Cheia" class="icon-fullscreen-enter"></button>
<button id="mute-button" onclick="toggleMute()" title="Ligar/Desligar Áudio" class="icon-unmute"></button>
<h2 class="Pizza_text">Pizza Tower - Web Edition</h2>
<div style="display:none;">
    <audio id="bgm-audio" loop src="soundtrack_jogo/Background_Music.mp3"></audio>
    <audio id="start-bgm-audio" loop src="soundtrack_jogo/Start_Music.mp3"></audio>
    <audio id="pepper-peppino-audio" loop src="soundtrack_jogo/Pepper_Pizza_Peppino_Music.mp3"></audio>
    <audio id="pepper-noise-audio" loop src="soundtrack_jogo/Pepper_Pizza_Noise.mp3"></audio>
    <audio id="sfx-audio" src=""></audio>
    <audio id="walk-audio" loop src="soundtrack_jogo/Peppino_step.wav"></audio>
    <audio id="conflict-audio" src="soundtrack_jogo/Parry.wav"></audio>
    <audio id="doise-bgm-audio" loop src="soundtrack_jogo/Doise_Mode_Music.mp3"></audio>
    <audio id="doise-hurt-audio" src="soundtrack_jogo/Doise_hurt.mp3"></audio>
    <audio id="pepper-doise-audio" loop src="soundtrack_jogo/Pepper_Pizza_Doise.mp3"></audio>
</div>
<div id="ui-bar">
    <div id="score">Score: 0</div>
    <div id="health">Hits: </div>
    <div id="timer">Time: 60</div>
</div>
<div id="main-container">
    <div id="start-screen" class="text-center">
        <button class="depression" onclick="hideStartScreen(); startNormalGame();">Start Game!</button> 
        <button class="depression doise-btn" onclick="hideStartScreen(); startDoiseMode();">Doise Mode</button>
    </div>
    <div id="game-area">
        <div id="player"></div> 
        <div id="the-noise"></div>
        <div id="gustavo"></div> 
    </div>
</div>
<div id="status" class="message2"> Controls: [A/D] to move, [W] to jump and [SHIFT] to run.</div>
<button id="reset-button" onclick="startGame()">Restart?</button>
<div id="rank-image-container" class="final-rank-image" style="display:none;"></div>
<script>
let isDoiseMode = false;

// CONFIGURAÇÕES DO MODO DE JOGO
let currentToppingChance = 1.0;
let currentPepperChance = 0.1;
let currentGustavoChance = 0.5;
let currentSpawnInterval = 1500;
let platformColor = '#f8e080';
let platformBorder = '#d88818';

//ELEMENTOS DE ÁUDIO
const DOISE_BGM = document.getElementById('doise-bgm-audio');
const DOISE_HURT_SFX_ELEMENT = document.getElementById('doise-hurt-audio');
const PEPPER_DOISE_AUDIO = document.getElementById('pepper-doise-audio');

// LÓGICA DO JOGO
const MAIN_CONTAINER = document.getElementById('main-container');
const START_SCREEN = document.getElementById('start-screen');
const GAME_AREA = document.getElementById('game-area');
const PLAYER = document.getElementById('player');
const NOISE = document.getElementById('the-noise');
const GUSTAVO = document.getElementById('gustavo');
const SCORE_DISPLAY = document.getElementById('score');
const HEALTH_DISPLAY = document.getElementById('health');
const TIMER_DISPLAY = document.getElementById('timer');
const STATUS_DISPLAY = document.getElementById('status');
const RANK_IMAGE_CONTAINER = document.getElementById('rank-image-container');
const MUTE_BUTTON = document.getElementById('mute-button');
const RESET_BUTTON = document.getElementById('reset-button');
const DESKTOP_FULLSCREEN_BUTTON = document.getElementById('desktop-fullscreen-button');
const MODE_SWITCH_BUTTON = document.getElementById('mode-switch-button');

// TELA CHEIA
function toggleDesktopFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Erro ao tentar ativar tela cheia: ${err.message}`);});
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();}}}
function updateDesktopFullscreenIcon() {
    if (document.fullscreenElement) {
        DESKTOP_FULLSCREEN_BUTTON.classList.remove('icon-fullscreen-enter');
        DESKTOP_FULLSCREEN_BUTTON.classList.add('icon-fullscreen-exit');
    } else {
        DESKTOP_FULLSCREEN_BUTTON.classList.remove('icon-fullscreen-exit');
        DESKTOP_FULLSCREEN_BUTTON.classList.add('icon-fullscreen-enter');}}
document.addEventListener('fullscreenchange', updateDesktopFullscreenIcon);
function toggleMute() {
    isMuted = !isMuted;
    const audios = document.querySelectorAll('audio');
    audios.forEach(a => a.muted = isMuted);
    if (isMuted) {
        MUTE_BUTTON.classList.replace('icon-unmute', 'icon-mute');
    } else {
        MUTE_BUTTON.classList.replace('icon-mute', 'icon-unmute');}}
const UNMUTE_ICON_SPRITE = "imagens_jogo/Stuff/unmute_button";
const MUTE_ICON_SPRITE = "imagens_jogo/Stuff/mute_button";
const FULLSCREEN_ENTER_ICON_SPRITE = "imagens_jogo/Stuff/fullscreen_on";
const FULLSCREEN_EXIT_ICON_SPRITE = "imagens_jogo/Stuff/fullscreen_off";

// TROCA DE MODO
function toggleGameMode() {
    isGameOver = true;
    if (isDoiseMode) {
        startNormalGame();
    } else {
        startDoiseMode();}}
function updateModeButton() {
    if (isDoiseMode) {
        MODE_SWITCH_BUTTON.classList.remove('icon-mode-doise');
        MODE_SWITCH_BUTTON.classList.add('icon-mode-noise');
    } else {
        MODE_SWITCH_BUTTON.classList.remove('icon-mode-noise');
        MODE_SWITCH_BUTTON.classList.add('icon-mode-doise');}}

//SPRITES DO PEPPINO
const PLAYER_IDLE_SPRITE = "url(imagens_jogo/P_sprites/Peppino_idle.gif";
const PLAYER_WALK_SPRITE = "url(imagens_jogo/P_sprites/Peppino_walk.gif)";
const PLAYER_RUN_SPRITE = "url(imagens_jogo/P_sprites/Peppino_run.gif)";
const PLAYER_JUMP_SPRITE = "url(imagens_jogo/P_sprites/Peppino_jump.gif)";
const PLAYER_WALL_SLIDE_SPRITE = "url(imagens_jogo/P_sprites/Peppino_wall.gif)";
const PLAYER_HURT_SPRITE = "url(imagens_jogo/P_sprites/Peppino_hurt.gif)";
const PLAYER_STUN_SPRITE = "url(imagens_jogo/P_sprites/Peppino_fireass.gif)";
const PEPPINO_PARRY_SPRITE = "url(imagens_jogo/P_sprites/Peppino_parry.gif)";
const PEPPER_SPRITE = "url(imagens_jogo/P_sprites/Pepper_Pizza_Peppino.gif)";
const PLAYER_TIRED_SPRITE = "url(imagens_jogo/P_sprites/Peppino_milk.gif)";
const PEPPINO_WIN_TIME_SPRITE = "url(imagens_jogo/P_sprites/Peppino_win.gif)"; 
const PEPPINO_LOSE_NOISE_SPRITE = "url(imagens_jogo/P_sprites/Peppino_lose.gif)"; 

//SPRITES DO THE NOISE
const NOISE_WALK_SPRITE = "url(imagens_jogo/N_sprites/Noise_walk.gif)";
const NOISE_JUMP_SPRITE = "url(imagens_jogo/N_sprites/Noise_jump.png)";
const NOISE_DOUBLE_JUMP_SPRITE = "url(imagens_jogo/N_sprites/Noise_doublejump.gif)";
const NOISE_SCARED_SPRITE = "url(imagens_jogo/N_sprites/Noise_scaried.gif)";
const NOISE_HAPPY_SPRITE = "url(imagens_jogo/N_sprites/Noise_happy.gif)";
const NOISE_POWERED_SPRITE = "url(imagens_jogo/N_sprites/Pepper_Pizza_Noise.gif)";
const STUNNED_SPRITE = "url(imagens_jogo/N_sprites/Noise_hurt.gif)";
const NOISE_IDLE_SPRITE_NEW = "url(imagens_jogo/N_sprites/Noise_stopped.png)";
const NOISE_TIRED_SPRITE = "url(imagens_jogo/N_sprites/Noise_milk.gif)";
const NOISE_PEPPER_STUN_SPRITE = "url(imagens_jogo/N_sprites/Noise_fireass.gif)";
const NOISE_POWERUP_PARRY_SPRITE = "url(imagens_jogo/N_sprites/Noise_parry.gif)";
const NOISE_LOSE_SPRITE = "url(imagens_jogo/N_sprites/Noise_lose.gif)";
const NOISE_WIN_SPRITE = "url(imagens_jogo/N_sprites/Noise_win.gif)";
const NOISE_JOKE_SPRITE = "url(imagens_jogo/N_sprites/Noise_joke.png)";
const F_NOISE_IDLE = "url(imagens_jogo/N_sprites/Noise_idle_D.gif)";
const F_NOISE_DROP = "url(imagens_jogo/N_sprites/Noise_drop.gif)";
const F_NOISE_SCARED = "url(imagens_jogo/N_sprites/Noise_P_hit.gif)";
const F_NOISE_HAPPY = "url(imagens_jogo/N_sprites/Noise_D_hit.gif)";
const F_NOISE_PANIC = "url(imagens_jogo/N_sprites/Noise_PD.gif)";
const F_NOISE_THUMBS = "url(imagens_jogo/N_sprites/Noise_PP.gif)";
const F_NOISE_WIN = "url(imagens_jogo/N_sprites/Noise_P_win.gif)";
const F_NOISE_LOSE = "url(imagens_jogo/N_sprites/Noise_D_win.png)";

// SPRITES DO DOISE
const DOISE_WALK_SPRITE = "url(imagens_jogo/D_sprites/Doise_walk.gif)";
const DOISE_JUMP_SPRITE = "url(imagens_jogo/D_sprites/Doise_jump.png)";
const DOISE_STUNNED_SPRITE = "url(imagens_jogo/D_sprites/Doise_hurt.png)";
const DOISE_POWERED_SPRITE = "url(imagens_jogo/D_sprites/Pepper_Pizza_Doise.gif)";
const DOISE_IDLE_SPRITE_NEW = "url(imagens_jogo/D_sprites/Doise_stopped.png)";
const DOISE_DOUBLE_JUMP_SPRITE = "url(imagens_jogo/D_sprites/Doise_doublejump.gif)";
const DOISE_SCARED_SPRITE = "url(imagens_jogo/D_sprites/Doise_scared.gif)";
const DOISE_HAPPY_SPRITE = "url(imagens_jogo/D_sprites/Doise_happy.gif)";
const DOISE_TIRED_SPRITE = "url(imagens_jogo/D_sprites/Doise_milk.gif)";
const DOISE_PEPPER_STUN_SPRITE = "url(imagens_jogo/D_sprites/Doise_fireass.gif)";
const DOISE_POWERUP_PARRY_SPRITE = "url(imagens_jogo/D_sprites/Doise_parry.gif)";
const DOISE_LOSE_SPRITE = "url(imagens_jogo/D_sprites/Doise_lose.gif)";
const DOISE_WIN_SPRITE = "url(imagens_jogo/D_sprites/Doise_win.gif)";
const DOISE_JOKE_SPRITE = "url(imagens_jogo/D_sprites/Doise_joke.png)";
const DOISE_BACKGROUND = "url(imagens_jogo/Stuff/backwong.png)";
const NORMAL_BACKGROUND = "url(imagens_jogo/Stuff/backwoag.png)";

// SPRITES DO GUSTAVO
const GUSTAVO_IDLE_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_idle.gif)";
const GUSTAVO_NOISE_HIT_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_N_hit.gif)";
const GUSTAVO_DROP_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_drop.gif)";
const GUSTAVO_PEPPINO_HIT_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_P_hit.gif)";
const GUSTAVO_PEPPER_PEPPINO_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_PP.gif)";
const GUSTAVO_PEPPER_NOISE_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_PN.gif)";
const GUSTAVO_WIN_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_P_win.gif)";
const GUSTAVO_LOSE_SPRITE = "url(imagens_jogo/G_sprites/Gustavo_N_win.gif)";

// DETALHES MÍNIMOS
const BASE_GAME_WIDTH = 900;
const BASE_GAME_HEIGHT = 500;
const BASE_PLAYER_WIDTH = 75;
const BASE_PLAYER_HEIGHT = 100;
const BASE_NOISE_WIDTH = 75;
const BASE_NOISE_HEIGHT = 100;
const BASE_GUSTAVO_WIDTH = 100; 
const BASE_GUSTAVO_HEIGHT = 110; 
const BASE_TOPPING_SIZE = 25;
const BASE_PLATFORM_WIDTH = 400;
const BASE_PLATFORM_HEIGHT = 20; 
const BASE_PLATFORM_Y = 180;
const BASE_PLAYER_START_X = 50;
const BASE_NOISE_START_X_POS = BASE_GAME_WIDTH - BASE_NOISE_WIDTH - 50;
let GAME_SCALE_FACTOR = 1;
function getScaledValue(baseValue) {
    return baseValue * GAME_SCALE_FACTOR;}
let GAME_WIDTH = BASE_GAME_WIDTH;
let GAME_HEIGHT = BASE_GAME_HEIGHT;
let PLAYER_WIDTH = BASE_PLAYER_WIDTH;
let PLAYER_HEIGHT = BASE_PLAYER_HEIGHT;
let NOISE_WIDTH = BASE_NOISE_WIDTH;
let NOISE_HEIGHT = BASE_NOISE_HEIGHT;
let TOPPING_SIZE = BASE_TOPPING_SIZE;
let NOISE_START_X = getScaledValue(BASE_NOISE_START_X_POS);
function updateScaledConstants() {
    GAME_WIDTH = GAME_AREA.clientWidth;
    GAME_HEIGHT = GAME_AREA.clientHeight;
    GAME_SCALE_FACTOR = GAME_WIDTH / BASE_GAME_WIDTH;
    PLAYER_WIDTH = getScaledValue(BASE_PLAYER_WIDTH);
    PLAYER_HEIGHT = getScaledValue(BASE_PLAYER_HEIGHT);
    NOISE_WIDTH = getScaledValue(BASE_NOISE_WIDTH);
    NOISE_HEIGHT = getScaledValue(BASE_NOISE_HEIGHT);
    TOPPING_SIZE = getScaledValue(BASE_TOPPING_SIZE);
    NOISE_START_X = getScaledValue(BASE_NOISE_START_X_POS);
    PLAYER.style.width = PLAYER_WIDTH + 'px';
    PLAYER.style.height = PLAYER_HEIGHT + 'px';
    NOISE.style.width = NOISE_WIDTH + 'px';
    NOISE.style.height = NOISE_HEIGHT + 'px';
    const GUSTAVO_WIDTH = getScaledValue(BASE_GUSTAVO_WIDTH); 
    const GUSTAVO_HEIGHT = getScaledValue(BASE_GUSTAVO_HEIGHT); 
    const GUSTAVO_X = (GAME_WIDTH / 2) - (GUSTAVO_WIDTH / 2);
    const GUSTAVO_Y = 0;
    GUSTAVO.style.width = GUSTAVO_WIDTH + 'px';
    GUSTAVO.style.height = GUSTAVO_HEIGHT + 'px';
    GUSTAVO.style.left = GUSTAVO_X + 'px';
    GUSTAVO.style.bottom = GUSTAVO_Y + 'px';
    GUSTAVO.style.transform = '';
    if (GAME_SCALE_FACTOR !== 0) {
        playerX = getScaledValue(playerX / (GAME_SCALE_FACTOR === 1 ? 1 : GAME_WIDTH / GAME_AREA.clientWidth));
        playerY = getScaledValue(playerY / (GAME_SCALE_FACTOR === 1 ? 1 : GAME_WIDTH / GAME_AREA.clientWidth));
        noiseX = getScaledValue(noiseX / (GAME_SCALE_FACTOR === 1 ? 1 : GAME_WIDTH / GAME_AREA.clientWidth));
        noiseY = getScaledValue(noiseY / (GAME_SCALE_FACTOR === 1 ? 1 : GAME_WIDTH / GAME_AREA.clientWidth));}
    if (!isGameOver) {
        createPlatforms();
        updateItemsPosition();}}
window.addEventListener('resize', () => {
    updateScaledConstants();});
const GRAVITY = 0.5;
const JUMP_STRENGTH = 15;
const HIT_INVINCIBILITY_TIME = 1500;
const POWERUP_INVINCIBILITY_TIME = 5000;
const PARITY_SPRITE_DURATION = 500;
const WALL_SLIDE_SPEED = 1.5;
const WALL_JUMP_HORIZONTAL_PUSH = 10;
const MAX_HEALTH = 6;
const NOISE_POWERED_SPEED = 7;
const MAX_NOISE_JUMPS = 2;
const NOISE_SPEED = 4;
const NOISE_JUMP_CHANCE = 0.05;
const NOISE_JUMP_STRENGTH = 12;
const NOISE_DOUBLE_JUMP_COOLDOWN = 100;
const NOISE_JOKE_DURATION = 2500; 
let score = 0;
let time = 60;
let isGameOver = true;
let health = MAX_HEALTH;
let hitsTaken = 0;
let keys = {};
let isInvincible = false;
let isPowerupInvincible = false;
let noiseIsPoweredUp = false;
let playerX = BASE_PLAYER_START_X;
let playerY = 0;
let velocityY = 0;
let isJumping = false;
let isWallSliding = false;
let isMoving = false;
let playerFacingRight = true;
let isPeppinoStunned = false;
let isParrying = false;
const PEPPINO_MILK_STUN_TIME = 800; 
const PEPPINO_NORMAL_STUN_TIME = 1000; 
const NOISE_STOMP_STUN_TIME = 2500;
const NOISE_PEPPER_STUN_TIME = 5000;
const WALK_SPEED = 5;
const RUN_SPEED = 10;
let currentSpeed = WALK_SPEED;
let noiseX = NOISE_START_X;
let noiseY = 0;
let noiseVY = 0;
let noiseJumpsUsed = 0;
let noiseIsStunned = false;
let noiseIsJoking = false;
let noiseLastJumpTime = 0;
const NOISE_STUN_TIME = 3000;
let noiseDirection = -1;
let currentNoiseSpeed = NOISE_SPEED;
const TOPPING_CLASSES = ['topping-1', 'topping-2', 'topping-3', 'topping-4', 'topping-5'];
let hasGeromeSpawned = false;

/* --- DADOS DA PLATAFORMA --- */
const platformBaseData = [
    { x: (BASE_GAME_WIDTH / 2) - (BASE_PLATFORM_WIDTH / 2), y: BASE_PLATFORM_Y, w: BASE_PLATFORM_WIDTH, h: BASE_PLATFORM_HEIGHT }];
let timerInterval;
let gameLoopInterval;
let spawnInterval;
let activePowerupElement = null;
let playerPowerupTimer;
let noisePowerupTimer;
let noiseStunTimer;
let parryTimer;
let gustavoState = 'idle';
let gustavoStateTimer;
const GUSTAVO_ANIM_DURATION = 500;
function createPlatforms() {
    document.querySelectorAll('.platform').forEach(p => p.remove());
    platformBaseData.forEach((data, index) => {
        const platform = document.createElement('div');
        platform.classList.add('platform');
        platform.id = `platform-${index}`;
        platform.style.left = getScaledValue(data.x) + 'px';
        platform.style.bottom = getScaledValue(data.y) + 'px';
        platform.style.width = getScaledValue(data.w) + 'px';
        platform.style.height = getScaledValue(data.h) + 'px';
        platform.style.backgroundColor = platformColor;
        platform.style.borderColor = platformBorder;
        GAME_AREA.appendChild(platform);});}
function updateItemsPosition() {
    platformBaseData.forEach((data, index) => {
        const platform = document.getElementById(`platform-${index}`);
        if (platform) {
            platform.style.left = getScaledValue(data.x) + 'px';
            platform.style.bottom = getScaledValue(data.y) + 'px';
            platform.style.width = getScaledValue(data.w) + 'px';
            platform.style.height = getScaledValue(data.h) + 'px';}});
    document.querySelectorAll('.topping, .power-up').forEach(item => {
        item.style.width = TOPPING_SIZE + 'px';
        item.style.height = TOPPING_SIZE + 'px';});}
function updateHealthDisplay() {
    HEALTH_DISPLAY.innerHTML = 'Hits: ';
    for (let i = 0; i < health; i++) {
        const heart = document.createElement('span');
        heart.id = 'heart-icon';
        HEALTH_DISPLAY.appendChild(heart);}
    for (let i = 0; i < MAX_HEALTH - health; i++) {
        const emptyHeart = document.createElement('span');
        emptyHeart.id = 'empty-heart-icon';
        HEALTH_DISPLAY.appendChild(emptyHeart);}}
const BGM_AUDIO = document.getElementById('bgm-audio');
const START_BGM_AUDIO = document.getElementById('start-bgm-audio');
const PEPPER_PEPPINO_AUDIO = document.getElementById('pepper-peppino-audio');
const PEPPER_NOISE_AUDIO = document.getElementById('pepper-noise-audio');
const WALK_AUDIO = document.getElementById('walk-audio');
const CONFLICT_AUDIO_ELEMENT = document.getElementById('conflict-audio');
const ALL_AUDIO_ELEMENTS = [BGM_AUDIO, START_BGM_AUDIO, PEPPER_PEPPINO_AUDIO, PEPPER_NOISE_AUDIO, WALK_AUDIO];
let isMuted = false;
let sfxVolume = 0.8;
let bgmVolume = 0.5;
function hideStartScreen() {
    START_BGM_AUDIO.pause();
    START_SCREEN.style.display = 'none';
    GAME_AREA.style.display = 'block';
    RESET_BUTTON.style.display = 'block';
    document.getElementById('ui-bar').style.display = 'flex';
    STATUS_DISPLAY.className = 'message';
    STATUS_DISPLAY.style.color = 'white';}
function showStartScreen() {
    if (!isMuted) {
        playBGM(START_BGM_AUDIO);}
    START_SCREEN.style.display = 'flex';
    GAME_AREA.style.display = 'none';
    RESET_BUTTON.style.display = 'none';
    document.getElementById('ui-bar').style.display = 'none';
    STATUS_DISPLAY.textContent = 'Controls: [A/D] to move, [W] to jump and [SHIFT] to run.';
    STATUS_DISPLAY.className = 'message2';
    STATUS_DISPLAY.style.color = 'black';}
function playSFX(soundPath, volume = sfxVolume) {
    if (isMuted) return;
    const sfx = new Audio(soundPath);
    sfx.volume = volume;
    sfx.play().catch(e => console.log("SFX Play Error: ", e));}
function playBGM(musicElement) {
    [BGM_AUDIO, START_BGM_AUDIO, PEPPER_PEPPINO_AUDIO, PEPPER_NOISE_AUDIO, DOISE_BGM, PEPPER_DOISE_AUDIO].forEach(audio => {
        if (audio !== musicElement) {
            audio.pause();
            audio.currentTime = 0;}});
    musicElement.muted = isMuted;
    musicElement.volume = bgmVolume;
    musicElement.play().catch(e => console.log("BGM Play Error: ", e));}
function stopBGM() {
    ALL_AUDIO_ELEMENTS.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;});
    DOISE_BGM.pause();
    PEPPER_DOISE_AUDIO.pause();}

// SOUNDTRACK PATHS
const SOUNDS = {
    HurtPeppino: "soundtrack_jogo/Peppino_hurt.wav",
    ScreamPeppino: "soundtrack_jogo/Peppino_scream.wav",
    HurtNoise: "soundtrack_jogo/Noise_hurt.wav",
    HurtDoise: "soundtrack_jogo/Doise_hurt.mp3",
    JumpPeppino: "soundtrack_jogo/Peppino_jump.wav",
    JumpNoise: "soundtrack_jogo/Noise_jump.wav",
    DoubleJumpNoise: "soundtrack_jogo/Double_jump.wav",
    RunPeppino: "soundtrack_jogo/Peppino_run.wav",
    WinPeppino: "soundtrack_jogo/Peppino_win.mp3",
    WinNoise: "soundtrack_jogo/Noise_win.mp3",
    WinDoise: "soundtrack_jogo/Doise_win.mp3",
    PepperSpawn: "soundtrack_jogo/Pepper_spawn.wav",
    ToppingCollect: "soundtrack_jogo/Topping_collect.wav",
    PepperCollect: "soundtrack_jogo/Pepper_collect.wav",
    BackgroundMusic: "soundtrack_jogo/Background_Music.mp3",
    StartScreenMusic: "soundtrack_jogo/Start_Music.mp3",
    PowerupConflict: "soundtrack_jogo/Parry.wav",
    GeromeSpawn: "soundtrack_jogo/Gerome_spawn.wav",
    GeromeCollect: "soundtrack_jogo/Gerome_collect.wav",
    LifeCollect: "soundtrack_jogo/Hat_collect.wav",
    GustavoDrop: "soundtrack_jogo/Gustavo_drop.mp3", 
    FriendlyDrop: "soundtrack_jogo/Noise_drop.mp3"};
function updateGustavoSprite() {
    GUSTAVO.classList.remove('facing-left', 'gustavo-idle-sprite', 'gustavo-noise-hit-sprite', 'gustavo-drop-sprite', 'gustavo-peppino-hit-sprite', 'gustavo-pepper-peppino-sprite', 'gustavo-pepper-noise-sprite', 'gustavo-win-sprite', 'gustavo-lose-sprite');
    const GUSTAVO_CENTER_X = GUSTAVO.offsetLeft + (GUSTAVO.offsetWidth / 2);
    if (playerX + (PLAYER_WIDTH / 2) < GUSTAVO_CENTER_X) {
        GUSTAVO.classList.add('facing-left');}
    if (isGameOver) {
        if (health <= 0) {
            GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_LOSE : GUSTAVO_LOSE_SPRITE;
        } else {
            GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_WIN : GUSTAVO_WIN_SPRITE;}
        return;}
    if (gustavoState === 'drop') {
        GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_DROP : GUSTAVO_DROP_SPRITE;
        return;}
    if (gustavoState === 'noise_hit') {
        GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_HAPPY : GUSTAVO_NOISE_HIT_SPRITE;
        return;}
    if (gustavoState === 'peppino_hit') {
        GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_SCARED : GUSTAVO_PEPPINO_HIT_SPRITE;
        return;}
    if (isPowerupInvincible) {
        GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_THUMBS : GUSTAVO_PEPPER_PEPPINO_SPRITE;
        return;}
    if (noiseIsPoweredUp) {
        GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_PANIC : GUSTAVO_PEPPER_NOISE_SPRITE;
        return;}
    GUSTAVO.style.backgroundImage = isDoiseMode ? F_NOISE_IDLE : GUSTAVO_IDLE_SPRITE;}
function setGustavoState(state, duration = GUSTAVO_ANIM_DURATION) {
    clearTimeout(gustavoStateTimer);
    gustavoState = state;
    gustavoStateTimer = setTimeout(() => {
        gustavoState = 'idle';
    }, duration);}
function updatePeppinoSprite() {
    const onPlatform = checkPlatformCollision();
    const isGrounded = playerY === 0 || onPlatform;
    const movingHorizontally = keys['arrowright'] || keys['d'] || keys['arrowleft'] || keys['a'];
    isMoving = movingHorizontally;
    if (isGrounded && isMoving) {
        if (WALK_AUDIO.paused && !isMuted && !isPeppinoStunned && !PLAYER.classList.contains('peppino-tired-sprite')) {
            WALK_AUDIO.volume = 0.3;
            WALK_AUDIO.loop = true;
            WALK_AUDIO.play().catch(e => console.log("Walk Audio Play Error: ", e));}
    } else {
        WALK_AUDIO.pause();
        WALK_AUDIO.currentTime = 0;}
    PLAYER.classList.remove('moving-sprite', 'running-sprite', 'stomp-mode', 'peppino-hurt-sprite', 'peppino-stun-sprite', 'wall-slide-sprite', 'peppino-parry-sprite');
    if (isPowerupInvincible) {
        if (isParrying) {
            PLAYER.style.backgroundImage = PEPPINO_PARRY_SPRITE;
            PLAYER.classList.add('peppino-parry-sprite');
            PLAYER.classList.remove('is-stunned', 'peppino-tired-sprite', 'invincible');
            return;}
        PLAYER.style.backgroundImage = PEPPER_SPRITE;
        PLAYER.classList.remove('is-stunned', 'peppino-tired-sprite');
        return;}
    if (PLAYER.classList.contains('peppino-tired-sprite')) {
        PLAYER.style.backgroundImage = PLAYER_TIRED_SPRITE;
        PLAYER.classList.add('is-stunned');
        return;}
    if (isInvincible) {
        if (isPeppinoStunned) {
            PLAYER.style.backgroundImage = PLAYER_STUN_SPRITE;
            PLAYER.classList.add('is-stunned');
        } else {
            PLAYER.style.backgroundImage = PLAYER_HURT_SPRITE;
            PLAYER.classList.add('peppino-hurt-sprite');
            PLAYER.classList.remove('is-stunned');}
        return;}
    PLAYER.classList.remove('is-stunned');
    if (isWallSliding) {
        PLAYER.style.backgroundImage = PLAYER_WALL_SLIDE_SPRITE;
        PLAYER.classList.add('wall-slide-sprite');
    } else if (playerY > 0 && !isGrounded) {
        PLAYER.style.backgroundImage = PLAYER_JUMP_SPRITE;
    } else if (isGrounded) {
        if (isMoving) {
            if (currentSpeed === RUN_SPEED) {
                PLAYER.style.backgroundImage = PLAYER_RUN_SPRITE;
                PLAYER.classList.add('running-sprite');
            } else {
                PLAYER.style.backgroundImage = PLAYER_WALK_SPRITE;
                PLAYER.classList.add('moving-sprite');}
        } else {
            PLAYER.style.backgroundImage = PLAYER_IDLE_SPRITE;}}
    if (keys['arrowright'] || keys['d']) {
        playerFacingRight = true;
    } else if (keys['arrowleft'] || keys['a']) {
        playerFacingRight = false;}
    if (playerFacingRight) {
        PLAYER.classList.remove('facing-left');
    } else {
        PLAYER.classList.add('facing-left');}}
function updateNoiseSprite() {
    const walkSprite = isDoiseMode ? DOISE_WALK_SPRITE : NOISE_WALK_SPRITE;
    const jumpSprite = isDoiseMode ? DOISE_JUMP_SPRITE : NOISE_JUMP_SPRITE;
    const doubleJumpSprite = isDoiseMode ? DOISE_DOUBLE_JUMP_SPRITE : NOISE_DOUBLE_JUMP_SPRITE;
    const stunnedSprite = isDoiseMode ? DOISE_STUNNED_SPRITE : STUNNED_SPRITE;
    const poweredSprite = isDoiseMode ? DOISE_POWERED_SPRITE : NOISE_POWERED_SPRITE;
    const jokeSprite = isDoiseMode ? DOISE_JOKE_SPRITE : NOISE_JOKE_SPRITE;
    const parrySprite = isDoiseMode ? DOISE_POWERUP_PARRY_SPRITE : NOISE_POWERUP_PARRY_SPRITE;
    const pepperStunSprite = isDoiseMode ? DOISE_PEPPER_STUN_SPRITE : NOISE_PEPPER_STUN_SPRITE;
    const tiredSprite = isDoiseMode ? DOISE_TIRED_SPRITE : NOISE_TIRED_SPRITE;
    const scaredSprite = isDoiseMode ? DOISE_SCARED_SPRITE : NOISE_SCARED_SPRITE;
    const happySprite = isDoiseMode ? DOISE_HAPPY_SPRITE : NOISE_HAPPY_SPRITE;
    const idleSprite = isDoiseMode ? DOISE_IDLE_SPRITE_NEW : NOISE_IDLE_SPRITE_NEW;
    if (noiseIsStunned || noiseIsJoking) {
        NOISE.classList.remove('noise-disabled');
        if (noiseIsJoking) {
            NOISE.style.backgroundImage = jokeSprite; 
            NOISE.classList.add('noise-joke-mode');
            return;}
        if (NOISE.style.backgroundImage === parrySprite) {
            NOISE.style.backgroundImage = parrySprite;
            return;}
        if (NOISE.style.backgroundImage === pepperStunSprite) {
            NOISE.style.backgroundImage = pepperStunSprite;
        } else {
            NOISE.style.backgroundImage = NOISE.classList.contains('noise-tired-sprite') ? tiredSprite : stunnedSprite;}
        return;}
    NOISE.classList.remove('is-stunned', 'invincible', 'noise-happy', 'noise-scared', 'noise-jumping', 'noise-double-jump', 'noise-powered-up', 'noise-idle-sprite', 'noise-tired-sprite', 'noise-joke-mode');
    const onPlatform = checkNoisePlatformCollision();
    const isGrounded = noiseY === 0 || onPlatform;
    if (isPowerupInvincible && noiseIsPoweredUp) {
        NOISE.style.backgroundImage = poweredSprite;
    } else if (noiseIsPoweredUp) {
        NOISE.style.backgroundImage = poweredSprite;
    } else if (isPowerupInvincible) {
        NOISE.style.backgroundImage = scaredSprite;
        NOISE.classList.add('noise-scared');
    } else if (activePowerupElement) {
        NOISE.style.backgroundImage = happySprite;
        NOISE.classList.add('noise-happy');
    } else {
        if (noiseY > 0 && !isGrounded) {
            if (noiseJumpsUsed === 2) {
                NOISE.style.backgroundImage = doubleJumpSprite;
                NOISE.classList.add('noise-double-jump');
            } else {
                NOISE.style.backgroundImage = jumpSprite;
                NOISE.classList.add('noise-jumping');}
        } else if (isGrounded) {
            const isStationary = Math.abs(noiseVY) < getScaledValue(0.1) && Math.abs(noiseX + noiseDirection * currentNoiseSpeed - noiseX) < getScaledValue(1);
            if (isStationary && !isDoiseMode) {
                NOISE.style.backgroundImage = idleSprite;
                NOISE.classList.add('noise-idle-sprite');
            } else {
                NOISE.style.backgroundImage = walkSprite;}}}
    let noiseFacingRight = noiseDirection === 1;
    if (noiseFacingRight) {
        NOISE.classList.remove('facing-left');
    } else {
        NOISE.classList.add('facing-left');}}
function checkPlatformCollision() {
    let onPlatform = false;
    document.querySelectorAll('.platform').forEach(platformElement => {
        const basePlatformX = parseFloat(platformElement.style.left) / GAME_SCALE_FACTOR;
        const basePlatformY = parseFloat(platformElement.style.bottom) / GAME_SCALE_FACTOR;
        const basePlatformW = parseFloat(platformElement.style.width) / GAME_SCALE_FACTOR;
        const basePlatformH = parseFloat(platformElement.style.height) / GAME_SCALE_FACTOR;
        const basePlayerX = playerX / GAME_SCALE_FACTOR;
        const basePlayerY = playerY / GAME_SCALE_FACTOR;
        const basePlayerW = BASE_PLAYER_WIDTH;
        const baseHorizontalOverlap = basePlayerX < basePlatformX + basePlatformW && basePlayerX + basePlayerW > basePlatformX;
        if (baseHorizontalOverlap) {
            const isFalling = velocityY <= 0;
            const landingRange = 5;
            const basePlayerBottom = basePlayerY;
            const basePlayerNextBottom = basePlayerY + (velocityY / GAME_SCALE_FACTOR);
            const basePlatformTop = basePlatformY + basePlatformH;
            if (isFalling && basePlayerNextBottom <= basePlatformTop && basePlayerBottom >= basePlatformTop - (landingRange / GAME_SCALE_FACTOR)) {
                playerY = getScaledValue(basePlatformTop);
                velocityY = 0;
                isJumping = false;
                onPlatform = true;}}});
    return onPlatform;}
function checkNoisePlatformCollision() {
    let onPlatform = false;
    document.querySelectorAll('.platform').forEach(platformElement => {
        const basePlatformX = parseFloat(platformElement.style.left) / GAME_SCALE_FACTOR;
        const basePlatformY = parseFloat(platformElement.style.bottom) / GAME_SCALE_FACTOR;
        const basePlatformW = parseFloat(platformElement.style.width) / GAME_SCALE_FACTOR;
        const basePlatformH = parseFloat(platformElement.style.height) / GAME_SCALE_FACTOR;
        const baseNoiseX = noiseX / GAME_SCALE_FACTOR;
        const baseNoiseW = BASE_NOISE_WIDTH;
        const baseHorizontalOverlap = baseNoiseX < basePlatformX + basePlatformW && baseNoiseX + baseNoiseW > basePlatformX;
        if (baseHorizontalOverlap) {
            const isFalling = noiseVY <= 0;
            const landingRange = 5;
            const baseNoiseBottom = noiseY;
            const baseNoiseNextBottom = noiseY + (noiseVY / GAME_SCALE_FACTOR);
            const basePlatformTop = basePlatformY + basePlatformH;
            if (isFalling && baseNoiseNextBottom <= basePlatformTop && baseNoiseBottom >= basePlatformTop - (landingRange / GAME_SCALE_FACTOR)) {
                noiseY = getScaledValue(basePlatformTop);
                noiseVY = 0;
                noiseJumpsUsed = 0;
                onPlatform = true;}}});
    return onPlatform;}
function updatePlayerPosition() {
    const SCALED_WALK_SPEED = getScaledValue(WALK_SPEED / BASE_GAME_WIDTH * GAME_WIDTH);
    const SCALED_RUN_SPEED = getScaledValue(RUN_SPEED / BASE_GAME_WIDTH * GAME_WIDTH);
    const SCALED_CURRENT_SPEED = currentSpeed === WALK_SPEED ? SCALED_WALK_SPEED : SCALED_RUN_SPEED;
    const SCALED_GRAVITY = getScaledValue(GRAVITY);
    const SCALED_WALL_SLIDE_SPEED = getScaledValue(WALL_SLIDE_SPEED);
    const SCALED_WALL_JUMP_HORIZONTAL_PUSH = getScaledValue(WALL_JUMP_HORIZONTAL_PUSH);
    if (PLAYER.classList.contains('peppino-tired-sprite') && isPeppinoStunned) {
        velocityY = 0;
        return;}
    if (isPeppinoStunned || isParrying) {
        let onPlatform = checkPlatformCollision();
        if (!onPlatform) { velocityY -= SCALED_GRAVITY; }
        playerY += velocityY;
        if (playerY <= 0) { playerY = 0; velocityY = 0; isJumping = false; }
        playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
        PLAYER.style.left = playerX + 'px';
        PLAYER.style.bottom = playerY + 'px';
        return;}
    let onPlatform = checkPlatformCollision();
    let isGrounded = playerY === 0 || onPlatform;
    const onLeftWall = playerX <= 0;
    const onRightWall = playerX >= GAME_WIDTH - PLAYER_WIDTH;
    if (!isGrounded && ((onLeftWall && (keys['ArrowLeft'] || keys['a'])) || (onRightWall && (keys['ArrowRight'] || keys['d'])))) {
        isWallSliding = true;
        if (velocityY < -SCALED_WALL_SLIDE_SPEED) { velocityY = -SCALED_WALL_SLIDE_SPEED; }
    } else { 
        isWallSliding = false;    }
    if (keys['arrowright'] || keys['d']) { playerX += SCALED_CURRENT_SPEED; }
    if (keys['arrowleft'] || keys['a']) { playerX -= SCALED_CURRENT_SPEED; }
    if (!isWallSliding && !onPlatform) { velocityY -= SCALED_GRAVITY; }
    playerY += velocityY;
    if (playerY >= GAME_HEIGHT - PLAYER_HEIGHT) { playerY = GAME_HEIGHT - PLAYER_HEIGHT; if (velocityY > 0) { velocityY = 0; } }
    if (playerY <= 0) { playerY = 0; velocityY = 0; isJumping = false; }
    playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
    PLAYER.style.left = playerX + 'px';
    PLAYER.style.bottom = playerY + 'px';}
function playerJump() {
    const SCALED_JUMP_STRENGTH = getScaledValue(JUMP_STRENGTH);
    const SCALED_WALL_JUMP_HORIZONTAL_PUSH = getScaledValue(WALL_JUMP_HORIZONTAL_PUSH);
    if (isGameOver || isPeppinoStunned || isParrying) return;
    WALK_AUDIO.pause();
    WALK_AUDIO.currentTime = 0;
    if (playerY === 0 || checkPlatformCollision()) {
        velocityY = SCALED_JUMP_STRENGTH;
        isJumping = true;
        playSFX(SOUNDS.JumpPeppino);
    } else if (isWallSliding) {
        velocityY = SCALED_JUMP_STRENGTH;
        isJumping = true;
        isWallSliding = false;
        playSFX(SOUNDS.JumpPeppino);
        const onLeftWall = playerX <= 0;
        if (onLeftWall) { playerX += SCALED_WALL_JUMP_HORIZONTAL_PUSH; } else { playerX -= SCALED_WALL_JUMP_HORIZONTAL_PUSH; }}}
function updateNoisePosition() {
    const SCALED_NOISE_SPEED = getScaledValue(NOISE_SPEED / BASE_GAME_WIDTH * GAME_WIDTH);
    const SCALED_NOISE_POWERED_SPEED = getScaledValue(NOISE_POWERED_SPEED / BASE_GAME_WIDTH * GAME_WIDTH);
    const SCALED_GRAVITY = getScaledValue(GRAVITY);
    if (noiseIsStunned || noiseIsJoking) {
        if (NOISE.classList.contains('invincible') && !NOISE.classList.contains('is-stunned')) {
            NOISE.classList.remove('invincible');}
        return;}
    let onPlatform = checkNoisePlatformCollision();
    let targetX;
    currentNoiseSpeed = SCALED_NOISE_SPEED;
    const isGrounded = noiseY === 0 || onPlatform;
    const canJump = isGrounded;
    if (isPowerupInvincible && noiseIsPoweredUp) {
        targetX = noiseX + noiseDirection * SCALED_NOISE_SPEED;
        currentNoiseSpeed = SCALED_NOISE_SPEED;
    } else if (noiseIsPoweredUp) {
        targetX = playerX;
        currentNoiseSpeed = SCALED_NOISE_POWERED_SPEED;
    } else if (isPowerupInvincible) {
        const distanceToPeppino = noiseX - playerX;
        targetX = noiseX + (distanceToPeppino > 0 ? currentNoiseSpeed : -currentNoiseSpeed) * 10;
        currentNoiseSpeed = SCALED_NOISE_POWERED_SPEED * 0.8;
        if (distanceToPeppino > 0) {
            noiseDirection = 1;
        } else {
            noiseDirection = -1;}
    } else if (activePowerupElement) {
        const powerupRect = activePowerupElement.getBoundingClientRect();
        const gameAreaRect = GAME_AREA.getBoundingClientRect();
        const powerupXGame = powerupRect.left - gameAreaRect.left;
        targetX = powerupXGame;
        currentNoiseSpeed = SCALED_NOISE_SPEED * 1.5;
        const powerupY = parseFloat(activePowerupElement.style.bottom);
        const isPowerupAboveNoise = powerupY > noiseY + NOISE_HEIGHT;
        const horizontalDistance = Math.abs(noiseX - powerupXGame);
        if (isPowerupAboveNoise) {
            if (canJump && horizontalDistance < NOISE_WIDTH * 2) {
                jumpNoise();
            } else if (!canJump && noiseJumpsUsed < MAX_NOISE_JUMPS) {
                jumpNoise();}
        } else if (canJump && Math.random() < NOISE_JUMP_CHANCE) {
            jumpNoise();}
    } else {
        targetX = noiseX + noiseDirection * SCALED_NOISE_SPEED;
        currentNoiseSpeed = SCALED_NOISE_SPEED;
        if (canJump && Math.random() < NOISE_JUMP_CHANCE) {
            jumpNoise();
        } else if (noiseJumpsUsed === 1 && Math.random() < NOISE_JUMP_CHANCE / 2) {
            jumpNoise();}}
    if (!isPowerupInvincible && !noiseIsPoweredUp) {
        if (targetX < noiseX) {
            noiseDirection = -1;
        } else if (targetX > noiseX) {
            noiseDirection = 1;}
    } else if (isPowerupInvincible && noiseIsPoweredUp) {
        if (noiseX <= 0) { noiseDirection = 1; }
        else if (noiseX >= GAME_WIDTH - NOISE_WIDTH) { noiseDirection = -1; }
    } else if (noiseIsPoweredUp) {
        if (noiseX < playerX) {
            noiseDirection = 1;
        } else if (noiseX > playerX) {
            noiseDirection = -1;}
    } else if (isPowerupInvincible) {
        if (targetX < noiseX) {
            noiseDirection = -1;
        } else if (targetX > noiseX) {
            noiseDirection = 1;}}
    noiseX += noiseDirection * currentNoiseSpeed;
    if (!noiseIsPoweredUp) {
        if (noiseX <= 0 || noiseX >= GAME_WIDTH - NOISE_WIDTH) {
            if (!isPowerupInvincible && !activePowerupElement) {
                noiseDirection *= -1;}
            noiseX = Math.max(0, Math.min(GAME_WIDTH - NOISE_WIDTH, noiseX));}}
    if (noiseIsPoweredUp && isNoiseFacingTarget(targetX)) {
        if (canJump || (noiseJumpsUsed === 1 && Math.random() < 0.5)) {
            jumpNoise();}}
    if (!onPlatform) { noiseVY -= SCALED_GRAVITY; }
    noiseY += noiseVY;
    if (noiseY >= GAME_HEIGHT - NOISE_HEIGHT) { noiseY = GAME_HEIGHT - NOISE_HEIGHT; if (noiseVY > 0) { noiseVY = 0; } }
    if (noiseY <= 0) {
        noiseY = 0;
        noiseVY = 0;
        noiseJumpsUsed = 0;}
    NOISE.style.left = noiseX + 'px';
    NOISE.style.bottom = noiseY + 'px';}
function isNoiseFacingTarget(targetX) {
    if (targetX > noiseX) { return noiseDirection === 1; }
    if (targetX < noiseX) { return noiseDirection === -1; }
    return false;}
function jumpNoise() {
    const SCALED_NOISE_JUMP_STRENGTH = getScaledValue(NOISE_JUMP_STRENGTH);
    const currentTime = Date.now();
    const isGrounded = noiseY === 0 || checkNoisePlatformCollision();
    if (isGrounded) {
        noiseVY = SCALED_NOISE_JUMP_STRENGTH;
        noiseJumpsUsed = 1;
        noiseLastJumpTime = currentTime;
        playSFX(SOUNDS.JumpNoise);
    } else if (noiseJumpsUsed === 1 && (currentTime - noiseLastJumpTime) >= NOISE_DOUBLE_JUMP_COOLDOWN) {
        noiseVY = SCALED_NOISE_JUMP_STRENGTH;
        noiseJumpsUsed++;
        playSFX(SOUNDS.DoubleJumpNoise);}}
function checkCollision() {
    const playerRect = PLAYER.getBoundingClientRect();
    const noiseRect = NOISE.getBoundingClientRect();
    const items = document.querySelectorAll('.topping, .power-up');
    items.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        if (isColliding(playerRect, itemRect)) {
            if (item.classList.contains('power-up')) {
                collectPowerup(item);
            } else if (item.classList.contains('topping-gerome')) {
                collectGerome(item);
            } else if (item.classList.contains('topping-life')) {
                collectLifeMushroom(item);
            } else {
                collectTopping(item);}}});
    items.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        if (isColliding(noiseRect, itemRect) && item.classList.contains('power-up') && !noiseIsPoweredUp) {
            collectNoisePowerup(item);}});
    if (isColliding(playerRect, noiseRect) && !noiseIsStunned && !noiseIsJoking) {
        if (isPowerupInvincible && noiseIsPoweredUp) {
            handleNoisePowerupConflict();
            return;}
        if (isPowerupInvincible) {
            handleNoisePepperHit();
            return;}
        if (noiseIsPoweredUp && !isInvincible) {
            handlePepperNoiseHitPeppino(); 
            return;}
        const isStomping = (velocityY < 0) && (playerY > noiseY + NOISE_HEIGHT - getScaledValue(10));
        if (isStomping) {
            handleNoiseStomp();
        } else if (!isInvincible) {
            handleNoiseHit(1);}}}
function isColliding(rect1, rect2) {
    return (rect1.left < rect2.right && rect1.right > rect2.left &&
    rect1.bottom > rect2.top && rect1.top < rect2.bottom);}

// FUNÇÕES DE DANO
function handleNoiseHit(damage = 1) {
    if (isInvincible) return;
    health -= damage;
    hitsTaken++;
    updateHealthDisplay();
    if (health <= 0) {
        endGame();
        return;}
    playSFX(SOUNDS.HurtPeppino);
    setGustavoState('peppino_hit'); 
    isInvincible = true;
    PLAYER.classList.add('invincible', 'peppino-hurt-sprite');
    const pushBack = getScaledValue(70);
    if (playerX < noiseX) { playerX -= pushBack; } else { playerX += pushBack; }
    playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
    STATUS_DISPLAY.textContent = `Hit! ${health} remaining Hit(s).`;
    setTimeout(() => {
        isInvincible = false;
        PLAYER.classList.remove('invincible', 'peppino-hurt-sprite');
        STATUS_DISPLAY.textContent = 'Get the Toppings!';
    }, HIT_INVINCIBILITY_TIME);}
function handlePepperNoiseHitPeppino() {
    if (isInvincible) return;
    health -= 2;
    hitsTaken += 2;
    updateHealthDisplay();
    if (health <= 0) {
        endGame();
        return;}
    playSFX(SOUNDS.ScreamPeppino);
    setGustavoState('peppino_hit'); 
    isInvincible = true;
    isPeppinoStunned = true;
    PLAYER.classList.add('invincible', 'peppino-stun-sprite', 'is-stunned');
    const pushBack = getScaledValue(100);
    if (playerX < noiseX) { playerX -= pushBack; } else { playerX += pushBack; }
    playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
    STATUS_DISPLAY.textContent = `Peppino was HEATED UP!`;
    noiseIsJoking = true;
    NOISE.classList.add('noise-joke-mode');
    const jokeSprite = isDoiseMode ? DOISE_JOKE_SPRITE : NOISE_JOKE_SPRITE;
    NOISE.style.backgroundImage = jokeSprite;
    setTimeout(() => {
        isPeppinoStunned = false;
        PLAYER.classList.remove('peppino-stun-sprite', 'is-stunned');
        updatePeppinoSprite();
    }, PEPPINO_NORMAL_STUN_TIME);
    setTimeout(() => {
        isInvincible = false;
        PLAYER.classList.remove('invincible');
        STATUS_DISPLAY.textContent = 'Get the Toppings!';
    }, HIT_INVINCIBILITY_TIME);
    clearTimeout(noiseStunTimer); 
    noiseStunTimer = setTimeout(() => {
        noiseIsJoking = false;
        NOISE.classList.remove('noise-joke-mode');
        updateNoiseSprite(); 
    }, NOISE_JOKE_DURATION);}
function attemptGustavoDrop(x, y) {
    if (Math.random() < currentGustavoChance) {
        const lifeTopping = document.createElement('div');
        lifeTopping.classList.add('topping', 'topping-life');
        const dropX = parseFloat(GUSTAVO.style.left) + (parseFloat(GUSTAVO.style.width) / 2) - (TOPPING_SIZE / 2);
        const dropY = parseFloat(GUSTAVO.style.bottom) + parseFloat(GUSTAVO.style.height) + getScaledValue(10);
        lifeTopping.style.left = dropX + 'px';
        lifeTopping.style.bottom = dropY + 'px';
        lifeTopping.style.width = TOPPING_SIZE + 'px';
        lifeTopping.style.height = TOPPING_SIZE + 'px';
        GAME_AREA.appendChild(lifeTopping);
        if (isDoiseMode) {
             playSFX(SOUNDS.FriendlyDrop);
        } else {
             playSFX(SOUNDS.GustavoDrop);}
        setGustavoState('drop', 1000);
        let name = isDoiseMode ? "Friendly Noise" : "Gustavo";
        STATUS_DISPLAY.textContent = `${name} dropped some HP!`;
        setTimeout(() => {
            if (STATUS_DISPLAY.textContent.includes("+1 Hit!")) {
                STATUS_DISPLAY.textContent = 'Keep going for a Better Rank!';}
        }, 1500);
        return true;}
    return false;}
function handleNoiseStomp() {
    const SCALED_JUMP_STRENGTH_HALF = getScaledValue(JUMP_STRENGTH / 2);
    velocityY = SCALED_JUMP_STRENGTH_HALF;
    const wasInvincible = isInvincible;
    if (!isPowerupInvincible) {
        isInvincible = true;
        PLAYER.classList.remove('peppino-hurt-sprite');
        PLAYER.classList.add('invincible', 'stomp-mode');}
    if (noiseIsPoweredUp) {
        endNoisePowerup();}
    clearTimeout(noiseStunTimer);
    noiseIsStunned = true;
    NOISE.classList.add('noise-disabled');
    if (isDoiseMode) {
        playSFX(SOUNDS.HurtDoise);
    } else {
        playSFX(SOUNDS.HurtNoise);}
    NOISE.style.backgroundImage = isDoiseMode ? DOISE_STUNNED_SPRITE : STUNNED_SPRITE;
    WALK_AUDIO.pause();
    WALK_AUDIO.currentTime = 0;
    STATUS_DISPLAY.textContent = isDoiseMode ? "The Doise was stomped!" : "The Noise was stomped!";
    attemptGustavoDrop(noiseX, noiseY);
    setGustavoState('noise_hit');
    setTimeout(() => {
        if (!wasInvincible && !isPowerupInvincible) {
            isInvincible = false;
            PLAYER.classList.remove('invincible', 'stomp-mode');}
        STATUS_DISPLAY.textContent = 'Get the Toppings!';
    }, HIT_INVINCIBILITY_TIME);
    noiseStunTimer = setTimeout(() => {
        noiseIsStunned = false;
        NOISE.classList.remove('noise-disabled');
        updateNoiseSprite();
    }, NOISE_STOMP_STUN_TIME);}
function collectNoisePowerup(powerupElement) {
    if (isGameOver || noiseIsPoweredUp) return;
    clearTimeout(noisePowerupTimer);
    powerupElement.remove();
    activePowerupElement = null;
    noiseIsPoweredUp = true;
    NOISE.classList.add('noise-powered-up');
    setGustavoState('pepper_noise', POWERUP_INVINCIBILITY_TIME);
    updateNoiseSprite();
    playSFX(SOUNDS.PepperCollect);
    if (isDoiseMode) {
        playBGM(PEPPER_DOISE_AUDIO);
        STATUS_DISPLAY.textContent = "The Doise got the Pepper Pizza! WHERE'S PEDDITO?";
    } else {
        playBGM(PEPPER_NOISE_AUDIO);
        STATUS_DISPLAY.textContent = "The Noise got the Pepper Pizza! RUN FOR YOUR LIFE!";
    }
    noisePowerupTimer = setTimeout(() => {
        endNoisePowerup();
    }, POWERUP_INVINCIBILITY_TIME);}
function endNoisePowerup() {
    clearTimeout(noisePowerupTimer);
    noiseIsPoweredUp = false;
    NOISE.classList.remove('noise-powered-up');
    noiseIsStunned = true;
    NOISE.classList.add('noise-disabled', 'noise-tired-sprite');
    updateNoiseSprite();
    if (isDoiseMode) {
        playBGM(DOISE_BGM);
    } else {
        playBGM(BGM_AUDIO);}    
    STATUS_DISPLAY.textContent = 'The dumbass calmed down!';
    clearTimeout(noiseStunTimer);
    gustavoState = 'idle';
    updateGustavoSprite();
    const NOISE_MILK_TIME = 500;
    setTimeout(() => {
        NOISE.classList.remove('noise-tired-sprite');
        NOISE.style.backgroundImage = isDoiseMode ? DOISE_STUNNED_SPRITE : STUNNED_SPRITE;
    }, NOISE_MILK_TIME);
    noiseStunTimer = setTimeout(() => {
        noiseIsStunned = false;
        NOISE.classList.remove('noise-disabled');
        updateNoiseSprite();
    }, POWERUP_INVINCIBILITY_TIME + NOISE_MILK_TIME);}
function handleNoisePepperHit() {
    noiseIsJoking = false; 
    noiseIsStunned = true;
    NOISE.classList.add('noise-disabled', 'is-stunned', 'invincible'); 
    const pepperStunSprite = isDoiseMode ? DOISE_PEPPER_STUN_SPRITE : NOISE_PEPPER_STUN_SPRITE;
    NOISE.style.backgroundImage = pepperStunSprite; 
    const pushBack = getScaledValue(100);
    if (playerX < noiseX) { noiseX += pushBack; } else { noiseX -= pushBack; }
    noiseX = Math.max(0, Math.min(GAME_WIDTH - NOISE_WIDTH, noiseX));
    STATUS_DISPLAY.textContent = `The dumbass was HEATED UP!`; 
    if (isDoiseMode) {
          playSFX(SOUNDS.HurtDoise);
    } else {
          playSFX(SOUNDS.HurtNoise);}
    attemptGustavoDrop(noiseX, noiseY);
    setGustavoState('noise_hit');
    clearTimeout(noiseStunTimer);
    noiseStunTimer = setTimeout(() => {
        noiseIsStunned = false;
        NOISE.classList.remove('noise-disabled', 'is-stunned', 'invincible'); 
        updateNoiseSprite();
        STATUS_DISPLAY.textContent = 'Get the Toppings!';
    }, NOISE_PEPPER_STUN_TIME);}
function handleNoisePowerupConflict() {
    playSFX(SOUNDS.PowerupConflict, 1.0);
    STATUS_DISPLAY.textContent = `I'm not gonna SUGARCOAT IT!`;
    clearTimeout(parryTimer);
    isParrying = true;
    PLAYER.classList.add('peppino-parry-sprite');
    PLAYER.classList.add('is-stunned');
    if (playerX < noiseX) {
        PLAYER.classList.remove('facing-left');
        playerFacingRight = true;
    } else {
        PLAYER.classList.add('facing-left');
        playerFacingRight = false;}
    noiseIsStunned = true;
    NOISE.classList.add('noise-disabled');    
    const parrySprite = isDoiseMode ? DOISE_POWERUP_PARRY_SPRITE : NOISE_POWERUP_PARRY_SPRITE;
    NOISE.style.backgroundImage = parrySprite;
    const pushBack = getScaledValue(50);
    if (playerX < noiseX) { playerX -= pushBack; } else { playerX += pushBack; }
    if (noiseX < playerX) { noiseX -= pushBack; } else { noiseX += pushBack; }
    playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
    noiseX = Math.max(0, Math.min(GAME_WIDTH - NOISE_WIDTH, noiseX));
    parryTimer = setTimeout(() => {
        isParrying = false;
        PLAYER.classList.remove('peppino-parry-sprite', 'is-stunned');
        updatePeppinoSprite();
        noiseIsStunned = false;
        NOISE.classList.remove('noise-disabled');
        updateNoiseSprite();
        STATUS_DISPLAY.textContent = 'Get the Toppings!';
    }, PARITY_SPRITE_DURATION);}
function collectTopping(toppingElement) {
    if (isGameOver) return;
    score += 100;
    SCORE_DISPLAY.textContent = `Score: ${score}`;
    toppingElement.remove();
    playSFX(SOUNDS.ToppingCollect);}
function collectGerome(geromeElement) {
    if (isGameOver) return;
    score += 500;
    SCORE_DISPLAY.textContent = `Score: ${score}`;
    geromeElement.remove();
    playSFX(SOUNDS.GeromeCollect);
    STATUS_DISPLAY.textContent = "You found Gerome! +500 Points!";}
function collectLifeMushroom(lifeElement) {
    if (isGameOver) return;
    lifeElement.remove();
    playSFX(SOUNDS.LifeCollect);
    if (health < MAX_HEALTH) {
        health = Math.min(MAX_HEALTH, health + 1);
        updateHealthDisplay();
        STATUS_DISPLAY.textContent = "+1 Hit!";
    } else {
        score += 100;
        SCORE_DISPLAY.textContent = `Score: ${score}`;
        STATUS_DISPLAY.textContent = "Max health! +100 Bonus Points!";}}
function collectPowerup(powerupElement) {
    if (isGameOver) return;
    clearTimeout(playerPowerupTimer);
    powerupElement.remove();
    activePowerupElement = null;
    isInvincible = true;
    isPowerupInvincible = true;
    isPeppinoStunned = false;
    PLAYER.classList.remove('is-stunned', 'peppino-tired-sprite', 'peppino-parry-sprite');
    PLAYER.classList.add('invincible');
    setGustavoState('pepper_peppino', POWERUP_INVINCIBILITY_TIME);
    updatePeppinoSprite();
    playSFX(SOUNDS.PepperCollect);
    playBGM(PEPPER_PEPPINO_AUDIO);
    STATUS_DISPLAY.textContent = "You got the Pepper pizza! 5 seconds of POWER!";
    playerPowerupTimer = setTimeout(() => {
        isInvincible = false;
        isPowerupInvincible = false;
        PLAYER.classList.remove('invincible', 'peppino-parry-sprite');
        PLAYER.classList.add('peppino-tired-sprite');
        playBGM(BGM_AUDIO);
        STATUS_DISPLAY.textContent = 'Have some milk!';
        isPeppinoStunned = true;
        PLAYER.classList.add('is-stunned');
        setTimeout(() => {
            PLAYER.classList.remove('peppino-tired-sprite');
            isPeppinoStunned = false;
            PLAYER.classList.remove('is-stunned');
            updatePeppinoSprite();
        }, PEPPINO_MILK_STUN_TIME);
    }, POWERUP_INVINCIBILITY_TIME);}
function getRandomSpawnPosition() {
    const spawnYPoints = [0];
    document.querySelectorAll('.platform').forEach(p => {
        const pY = parseFloat(p.style.bottom);
        const pH = parseFloat(p.style.height);
        spawnYPoints.push(pY + pH);});
    const selectedY = spawnYPoints[Math.floor(Math.random() * spawnYPoints.length)];
    const scaledToppingSize = TOPPING_SIZE;
    if (selectedY === 0) {
        return {
            x: Math.random() * (GAME_WIDTH - scaledToppingSize),
            y: selectedY + getScaledValue(5)};
    } else {
        let platformElement = Array.from(document.querySelectorAll('.platform')).find(p => parseFloat(p.style.bottom) + parseFloat(p.style.height) === selectedY);
        if (platformElement) {
            const minX = parseFloat(platformElement.style.left);
            const maxX = minX + parseFloat(platformElement.style.width) - scaledToppingSize;
            return {
                x: minX + Math.random() * (maxX - minX),
                y: selectedY};}
        return {
            x: Math.random() * (GAME_WIDTH - scaledToppingSize),
            y: 0};}}
function spawnTopping() {
    if (isGameOver) return;
    if (Math.random() < currentPepperChance && !activePowerupElement) {
        const powerup = document.createElement('div');
        powerup.classList.add('power-up', 'invincibility-powerup');
        const { x, y } = getRandomSpawnPosition();
        powerup.style.left = x + 'px';
        powerup.style.bottom = y + 'px';
        powerup.style.width = TOPPING_SIZE + 'px';
        powerup.style.height = TOPPING_SIZE + 'px';
        GAME_AREA.appendChild(powerup);
        activePowerupElement = powerup;
        updateNoiseSprite();
        playSFX(SOUNDS.PepperSpawn);
        setTimeout(() => {
            if (powerup.parentNode === GAME_AREA) {
                powerup.remove();
                activePowerupElement = null;
                updateNoiseSprite();}
        }, POWERUP_INVINCIBILITY_TIME);}
    if (document.querySelectorAll('.topping').length < 10) {
        if (Math.random() < currentToppingChance) {
            const topping = document.createElement('div');
            let randomToppingClass;
            const chance = Math.random();
            if (!hasGeromeSpawned && chance < 0.10) {
                randomToppingClass = 'topping-gerome';
                hasGeromeSpawned = true;
                playSFX(SOUNDS.GeromeSpawn);
            } else {
                randomToppingClass = TOPPING_CLASSES[Math.floor(Math.random() * TOPPING_CLASSES.length)];}
            topping.classList.add('topping', randomToppingClass);
            const { x, y } = getRandomSpawnPosition();
            topping.style.left = x + 'px';
            topping.style.bottom = y + 'px';
            topping.style.width = TOPPING_SIZE + 'px';
            topping.style.height = TOPPING_SIZE + 'px';
            GAME_AREA.appendChild(topping);}}}
function calculateRank(hits, finalScore) {
    if (health <= 0) {
        return {
            rank: 'DEAD',
            rankClass: 'rank-DEAD-image',
            message: 'YOU DIED!',
            color: '#d0b8b8'};}
    let rank = 'F-RANK';
    let rankClass = 'rank-F-image';
    let rankMessage = '';
    let rankColor = 'gray';
    if (hits === 0) {
        rank = 'P-RANK';
        rankClass = 'rank-P-image';
        rankMessage = 'Perfection!';
        rankColor = '#570faf';
    } else if (hits <= 1 && finalScore >= 3000) {
        rank = 'S-RANK';
        rankClass = 'rank-S-image';
        rankMessage = 'Your rank is (almost) PERFECT!';
        rankColor = '#e28f01';
    } else if (hits <= 2 && finalScore >= 2500) {
        rank = 'A-RANK';
        rankClass = 'rank-A-image';
        rankMessage = 'Your rank is AMAZING!';
        rankColor = '#fe1800';
    } else if (hits <= 3 && finalScore >= 2000) {
        rank = 'B-RANK';
        rankClass = 'rank-B-image';
        rankMessage = 'Your rank is OK.';
        rankColor = '#78a5ff';
    } else if (hits <= 4 && finalScore >= 1500) {
        rank = 'C-RANK';
        rankClass = 'rank-C-image';
        rankMessage = 'Your rank is crappy.';
        rankColor = '#00b00d';
    } else if (hits <= 5 && finalScore >= 1000) {
        rank = 'D-RANK';
        rankClass = 'rank-D-image';
        rankMessage = 'Your rank is AWFUL!';
        rankColor = '#464646';
    } else {
        rankMessage = `YOU SUCK!`;
        rankClass = 'rank-F-image';
        rankColor = 'gray';}
    return { rank, rankClass, message: rankMessage, color: rankColor };
}function gameLoop() {
    updatePeppinoSprite();
    updateNoiseSprite();
    updateGustavoSprite();
    updatePlayerPosition();
    updateNoisePosition();
    checkCollision();
    score = Math.max(0, score);}
function startTimer() {
    timerInterval = setInterval(() => {
        time--;
        TIMER_DISPLAY.textContent = `Time: ${time}`;
        if (time <= 0) {
            clearInterval(timerInterval);
            endGame(true);}}, 1000);}
function endGame(timeUp = false) {
    isGameOver = true;
    clearInterval(timerInterval);
    clearInterval(gameLoopInterval);
    clearInterval(spawnInterval);
    clearTimeout(playerPowerupTimer);
    clearTimeout(noisePowerupTimer);
    clearTimeout(noiseStunTimer);
    clearTimeout(parryTimer);
    clearTimeout(gustavoStateTimer);
    document.querySelectorAll('.topping, .power-up').forEach(t => t.remove());
    RANK_IMAGE_CONTAINER.style.display = 'none';
    stopBGM();
    activePowerupElement = null;
    isPowerupInvincible = false;
    noiseIsPoweredUp = false;
    noiseIsStunned = false;
    noiseIsJoking = false;
    isPeppinoStunned = false;
    isParrying = false;
    PLAYER.classList.remove('moving-sprite', 'running-sprite', 'stomp-mode', 'invincible', 'peppino-tired-sprite', 'peppino-hurt-sprite', 'peppino-stun-sprite', 'is-stunned', 'wall-slide-sprite', 'peppino-parry-sprite');
    PLAYER.style.backgroundImage = PLAYER_IDLE_SPRITE;
    NOISE.classList.remove('noise-disabled', 'noise-jumping', 'noise-double-jump', 'noise-happy', 'noise-scared', 'noise-powered-up', 'noise-idle-sprite', 'noise-tired-sprite', 'noise-joke-mode', 'is-stunned', 'invincible');
    NOISE.style.backgroundImage = isDoiseMode ? DOISE_WALK_SPRITE : NOISE_WALK_SPRITE;
    const rankData = calculateRank(hitsTaken, score);
    
    // VITÓRIA DO NOISE/DOISE
    if (health <= 0) {
        STATUS_DISPLAY.textContent = `F-RANK! ${rankData.message} Points: ${score}.`;
        STATUS_DISPLAY.style.color = rankData.color;
        PLAYER.style.backgroundImage = PEPPINO_LOSE_NOISE_SPRITE;
        if (isDoiseMode) {
            playSFX(SOUNDS.WinDoise);
            NOISE.style.backgroundImage = DOISE_WIN_SPRITE; 
        } else {
            playSFX(SOUNDS.WinNoise);
            NOISE.style.backgroundImage = NOISE_WIN_SPRITE;}
        NOISE.classList.remove('facing-left');
        RANK_IMAGE_CONTAINER.style.display = 'block';
        RANK_IMAGE_CONTAINER.className = `final-rank-image ${rankData.rankClass}`;
    
    // VITÓRIA DO PEPPINO
    } else if (timeUp) {
        playSFX(SOUNDS.WinPeppino);
        STATUS_DISPLAY.textContent = `${rankData.rank}! ${rankData.message} Points: ${score}.`;
        STATUS_DISPLAY.style.color = rankData.color;
        RANK_IMAGE_CONTAINER.style.display = 'block';
        RANK_IMAGE_CONTAINER.className = `final-rank-image ${rankData.rankClass}`;
        PLAYER.style.backgroundImage = PEPPINO_WIN_TIME_SPRITE;
        if (isDoiseMode) {
            NOISE.style.backgroundImage = F_NOISE_LOSE; 
        } else {
            NOISE.style.backgroundImage = NOISE_LOSE_SPRITE;}
        NOISE.classList.remove('facing-left');}
    STATUS_DISPLAY.style.display = 'block';
    RESET_BUTTON.style.display = 'block';
    updateGustavoSprite();}

// CONTROLES DO TECLADO
document.addEventListener('keydown', (e) => {
    if (isGameOver || isPeppinoStunned || isParrying) return;
    const key = e.key.toLowerCase();
    keys[key] = true;
    if (key === ' ' || key === 'w') {
        playerJump();}
    if (key === 'shift' && currentSpeed === WALK_SPEED) {
        currentSpeed = RUN_SPEED;}});
document.addEventListener('keyup', (e) => {
    const key = e.key.toLowerCase();
    keys[key] = false;
    if (key === 'shift') {
        currentSpeed = WALK_SPEED;}});

// INICIALIZAÇÃO
function startNormalGame() {
    isDoiseMode = false;
    currentToppingChance = 1.0;
    currentPepperChance = 0.1;
    currentGustavoChance = 0.5;
    currentSpawnInterval = 1500;
    platformColor = '#f8e080';
    platformBorder = '#d88818';
    updateModeButton();
    startGame();}
function startDoiseMode() {
    isDoiseMode = true;
    currentToppingChance = 0.8;
    currentPepperChance = 0.075;
    currentGustavoChance = 0.25;
    currentSpawnInterval = 1400;
    platformColor = '#2c6ebf';
    platformBorder = '#d868a0';
    updateModeButton();
    startGame();}
function startGame() {
    updateScaledConstants();
    if (!isGameOver) { endGame(); }
    if (START_SCREEN.style.display !== 'none') {
        hideStartScreen();}
    score = 0;
    health = MAX_HEALTH;
    hitsTaken = 0;
    isGameOver = false;
    keys = {};
    currentSpeed = WALK_SPEED;
    isInvincible = false;
    isPowerupInvincible = false;
    noiseIsPoweredUp = false;
    activePowerupElement = null;
    isWallSliding = false;
    noiseIsStunned = false;
    noiseIsJoking = false;
    isPeppinoStunned = false;
    isParrying = false;
    playerFacingRight = true;
    hasGeromeSpawned = false;
    clearTimeout(playerPowerupTimer);
    clearTimeout(noisePowerupTimer);
    clearTimeout(noiseStunTimer);
    clearTimeout(parryTimer);
    clearTimeout(gustavoStateTimer);
    gustavoState = 'idle';
    velocityY = 0;
    noiseVY = 0;
    noiseLastJumpTime = 0;
    PLAYER.classList.remove('invincible', 'stomp-mode', 'facing-left', 'running-sprite', 'moving-sprite', 'peppino-tired-sprite', 'peppino-hurt-sprite', 'peppino-stun-sprite', 'is-stunned', 'wall-slide-sprite', 'peppino-parry-sprite');
    PLAYER.style.backgroundImage = PLAYER_IDLE_SPRITE;
    NOISE.classList.remove('noise-disabled', 'facing-left', 'noise-jumping', 'noise-double-jump', 'noise-happy', 'noise-scared', 'noise-powered-up', 'noise-idle-sprite', 'noise-tired-sprite', 'noise-joke-mode', 'is-stunned', 'invincible');
    NOISE.style.backgroundImage = NOISE_WALK_SPRITE;
    updateGustavoSprite();
    RANK_IMAGE_CONTAINER.style.display = 'none';
    clearInterval(timerInterval);
    clearInterval(gameLoopInterval);
    clearInterval(spawnInterval);
    document.querySelectorAll('.topping, .power-up').forEach(t => t.remove());
    SCORE_DISPLAY.textContent = 'Score: 0';
    updateHealthDisplay();
    STATUS_DISPLAY.textContent = 'Use the platforms to get the Toppings!';
    STATUS_DISPLAY.className = 'message';
    STATUS_DISPLAY.style.color = 'white';
    STATUS_DISPLAY.style.display = 'block';
    if (isDoiseMode) {
        time = 90;
        playBGM(DOISE_BGM);
        currentNoiseSpeed = NOISE_SPEED * 1.2;
        GAME_AREA.style.backgroundImage = DOISE_BACKGROUND;
        playerX = getScaledValue(GAME_WIDTH - PLAYER_WIDTH - 50); 
        noiseX = getScaledValue(50);
    } else {
        time = 60;
        playBGM(BGM_AUDIO);
        currentNoiseSpeed = NOISE_SPEED;
        GAME_AREA.style.backgroundImage = NORMAL_BACKGROUND;
        playerX = getScaledValue(BASE_PLAYER_START_X);
        noiseX = NOISE_START_X;}
    TIMER_DISPLAY.textContent = `Time: ${time}`;
    playerY = 0;
    noiseY = 0;
    PLAYER.style.left = playerX + 'px';
    PLAYER.style.bottom = playerY + 'px';
    NOISE.style.left = noiseX + 'px';
    NOISE.style.bottom = noiseY + 'px';
    createPlatforms();
    startTimer();
    gameLoopInterval = setInterval(gameLoop, 1000 / 60);
    for (let i = 0; i < 3; i++) {
        const topping = document.createElement('div');
        const randomToppingClass = TOPPING_CLASSES[Math.floor(Math.random() * TOPPING_CLASSES.length)];
        topping.classList.add('topping', randomToppingClass);
        const { x, y } = getRandomSpawnPosition();
        topping.style.left = x + 'px';
        topping.style.bottom = y + 'px';
        topping.style.width = TOPPING_SIZE + 'px';
        topping.style.height = TOPPING_SIZE + 'px';
        GAME_AREA.appendChild(topping);}
    spawnInterval = setInterval(spawnTopping, currentSpawnInterval);}
window.onload = () => {
    updateScaledConstants();
    isGameOver = true;
    updateHealthDisplay();
    playBGM(START_BGM_AUDIO);
    showStartScreen();
    MUTE_BUTTON.classList.add(UNMUTE_ICON_SPRITE);
    updateModeButton();};
</script>
</body>
</html>